<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="../js/jquery.tmpl.min.js"></script>
<title>FAQ 목록</title>
<script>
	function fnAddFileRow() {
		if($('.file').length == 5) {
			alert('이미지는 최대 다섯개까지 추가 가능합니다.');
			return;
		}

		$('#addFileRow').tmpl().appendTo('#faqTable');
	}

	function fnDelFileRow(seq) {
		if(confirm('삭제하시겠습니까?')) {
			$.ajax({
				url : '/faq/deleteByImgSeq',
				data : {'imgSeq' : seq},
				type : 'post',
				success : function(res) {
					alert('삭제되었습니다.');
					location.reload();
				},
				error : function() {
					console.log('에러발생');
				}
			});
		}
	}

	$.fn.serializeObject = function() {
	  var result = {}
	  var extend = function(i, element) {
	    var node = result[element.name]
	    if ("undefined" !== typeof node && node !== null) {
	      if ($.isArray(node)) {
	        node.push(element.value)
	      } else {
	        result[element.name] = [node, element.value]
	      }
	    } else {
	      result[element.name] = element.value
	    }
	  }

	  $.each(this.serializeArray(), extend)
	  return result
	}


	function fnRegBtn() {
		if($('#faqTitle').val() == '') {
			alert('제목을 입력해 주세요');
			$('#faqTitle').focus();
			return;
		}

		if($('#faqContent').val() == '') {
			alert('내용을 입력해 주세요');
			$('#faqContent').focus();
			return;
		}

		var formData = new FormData($('#frm')[0]);

		$.ajax({
			 url 		: '/faq/edit'
			,type 		: 'post'
			,data 		: formData
			,contentType: false
			,processData: false
			,success	: function(res) {
				alert('저장 성공');
				location.href = '/faq/list';
			}
			,error 		: function(request) {
				alert(JSON.parse(request.responseText).reason);
			}
		})
	}
	function fnAddFileRow() {
		if($('.file').length == 5) {
			alert('이미지는 최대 다섯개까지 추가 가능합니다.');
			return;
		}

		$('#addFileRow').tmpl([{idx : $('.file').length}]).appendTo('#faqTable');
	}

	function fnFileUpload(obj, idx) {
		let fileNm = $(obj).val().split('/').pop().split('\\').pop();
		let _ext = fileNm.lastIndexOf('.')+1;

		let ext = fileNm.substring(_ext, fileNm.length).toLowerCase();
		if (/(\.gif|\.jpg|\.jpeg|\.png)$/i.test(obj.value) == false) {
			alert("이미지 형식의 파일을 선택하십시오");
			return;
		}

		$('#fileChangeYn'+idx).val('Y');
		var reader = new FileReader();
		var src = '';
		reader.onload = function(e) {
			console.log(e.target.result);
			src = e.target.result
		}

// 		reader.readAsDataURL(src);


		$('#fileNm'+idx).text(fileNm);
	}
</script>
</head>
<body>
	<form id="frm" name="frm">
		<div align="center" th:object="${faq}">
			<input type="hidden" id="faqSeq" name="faqSeq" th:value="*{faqSeq}">
			<table id="faqTable">
				<tr>
					<th>제목</th>
					<td><input type="text" id="faqTitle" name="faqTitle" th:value="*{faqTitle}"></td>
				</tr>
				<tr>
					<th>내용</th>
					<td><input type="text" id="faqContent" name="faqContent" th:value="*{faqContent}"></td>
				</tr>
				<tr>
					<td rowspan="6">첨부파일</td>
					<td><button type="button" onclick="fnAddFileRow()">추가</button></td>
				</tr>
				<tr th:each="faqImg, i : ${faq.faqImgList}">
					<td >
						<img th:src="'../upload/'+${faqImg.faqImg}+''" style="width: 200px;">
						<input type="hidden" th:id="'imgSeq'+${i.index}+''" th:name="'faqImgList['+${i.index}+'].imgSeq'" th:value="${faqImg.imgSeq}">
						<input type="hidden" th:id="'fileChangeYn'+${i.index}+''" th:name="'faqImgList['+${i.index}+'].fileChangeYn'">
						<input class="file" type="file" th:id="'file'+${i.index}+''" name="file" style="display:none;" th:onchange="'fnFileUpload(this,'+${i.index}+')'" accept=".gif, .jpg, .png, .jpeg">
						<label th:for="'file'+${i.index}+''" th:id="'fileNm'+${i.index}+''">[[${faqImg.imgNm}]]</label>
						<button type="button" th:onclick="|fnDelFileRow(${faqImg.imgSeq})|">-</button>
					</td>
				</tr>
			</table>
			<div>
				<button type="button" onclick="fnRegBtn()">저장</button>
			</div>
		</div>
	</form>
</body>
<script type="text/x-jQuery-tmpl" id="addFileRow">
	<tr>
		<td>
			<input type="hidden" id="imgSeq" name="faqImgList[{{= idx}}].imgSeq" value="0">
			<input type="hidden" id="fileChangeYn{{= idx}}" name="faqImgList[{{= idx}}].fileChangeYn" value="Y">
			<input type="file" name="file" id="file{{= idx}}" class="file" style="display:none;" onchange="fnFileUpload(this, {{= idx}})" accept=".gif, .jpg, .png, .jpeg">
			<label for="file{{= idx}}" id="fileNm{{= idx}}">선택된 파일 없음</label>
			<button type="button" onclick="fnDelFileRow(this)">삭제</button>
		</td>
	</tr>
</script>
</html>